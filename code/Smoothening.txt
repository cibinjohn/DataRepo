import pandas as pd
from scipy import stats

def smooth_predictions(df, window_size=3):
    """
    Apply smoothing to NER predictions using a rolling window with mode.
    
    Parameters:
    -----------
    df : pandas.DataFrame
        DataFrame with 'token' and 'prediction' columns
    window_size : int
        Size of the window (must be odd for symmetric windows)
        Default is 3 (considers 1 preceding + current + 1 succeeding)
    
    Returns:
    --------
    pandas.DataFrame
        DataFrame with original columns plus 'smoothed_prediction' column
    """
    
    df_smoothed = df.copy()
    smoothed = []
    
    half_window = window_size // 2
    
    for i in range(len(df)):
        # Define window boundaries
        start = max(0, i - half_window)
        end = min(len(df), i + half_window + 1)
        
        # Get window of predictions
        window = df['prediction'].iloc[start:end]
        
        # Calculate mode (most frequent value)
        mode_value = window.mode()
        
        # If there's a mode, use it; otherwise keep original
        if len(mode_value) > 0:
            smoothed.append(mode_value.iloc[0])
        else:
            smoothed.append(df['prediction'].iloc[i])
    
    df_smoothed['smoothed_prediction'] = smoothed
    
    return df_smoothed


# Alternative: Using custom before/after parameters
def smooth_predictions_custom(df, before=1, after=1):
    """
    Apply smoothing with explicit control over preceding and succeeding context.
    
    Parameters:
    -----------
    df : pandas.DataFrame
        DataFrame with 'token' and 'prediction' columns
    before : int
        Number of preceding tokens to consider
    after : int
        Number of succeeding tokens to consider
    """
    
    df_smoothed = df.copy()
    smoothed = []
    
    for i in range(len(df)):
        # Define window boundaries
        start = max(0, i - before)
        end = min(len(df), i + after + 1)
        
        # Get window of predictions
        window = df['prediction'].iloc[start:end]
        
        # Calculate mode
        mode_value = window.mode()
        
        # Use mode if available, otherwise keep original
        if len(mode_value) > 0:
            smoothed.append(mode_value.iloc[0])
        else:
            smoothed.append(df['prediction'].iloc[i])
    
    df_smoothed['smoothed_prediction'] = smoothed
    
    return df_smoothed


# Example usage:
data = {
    'token': ['The', 'quick', 'brown', 'fox', 'jumps', 'over', 'the', 'dog'],
    'prediction': ['O', 'B-ADJ', 'O', 'B-NOUN', 'B-NOUN', 'O', 'O', 'B-NOUN']
}
df = pd.DataFrame(data)

# Apply smoothing
df_smoothed = smooth_predictions(df, window_size=3)
print(df_smoothed[['token', 'prediction', 'smoothed_prediction']])
